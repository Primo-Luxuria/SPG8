
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Courses</title>
    <style>
        body { font-family: Arial, sans-serif; }
	textarea {width: 100%;min-height: 100px;resize: vertical;font-size: 16px;padding: 8px;}
        .course-container { background: #f4f4f4; padding: 15px; margin: 15px 0; border-radius: 8px; width: 80%; }
        details { margin-top: 10px; padding: 10px; background: #e0e0e0; border-radius: 5px; }
        .remove-btn { background: red; color: white; padding: 8px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;}
        .tab-container { margin-top: 10px; }
        .tabs { display: flex; cursor: pointer; border-bottom: 2px solid #cccccc; }
        .tab { padding: 8px 12px; border: 1px solid #cccccc; border-bottom: none; background: #d9d9d9; }
        .tab.active { background: #ffffff; font-weight: bold; }
        .tab-content { display: none; padding: 10px; height: 120px; overflow-y: auto; border: 1px solid #ccc; }
        .tab-content.active { display: block;}
        .add-btn { background: #0077C8; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;}
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow:hidden; align-items:center; justify-content:center;}
        .modal-content { background: white; padding: 20px; width: 50%; max-height:80vh; overflow-y:auto; margin: 5% auto; border-radius: 10px;}
        .close-btn { background: red; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer;}
	
    </style>
</head>
<body>

    <h1>Manage Your Courses</h1>

    <!-- Course Input Form -->

    <div style="background:#e0e0e0;padding:20px;">
    <input type="text" id="courseID" placeholder="Enter Course ID" required>
    <input type="text" id="courseName" placeholder="Enter Course Name" required>
    <input type="text" id="courseCRN" placeholder="Enter CRN" required>
    <select id="courseSemester" required>
        <option value="" disabled selected>Select Semester</option>
        <option value="Spring">Spring</option>
        <option value="Summer">Summer</option>
        <option value="Fall">Fall</option>
        <option value="Winter">Winter</option>
    </select><br/><br/>

    <input type="text" id="courseTextbookTitle" placeholder="Enter Textbook Title" required>
    <input type="text" id="courseTextbookAuthor" placeholder="Enter Textbook Author" required>
    <input type="text" id="courseTextbookVersion" placeholder="Enter Textbook Version" required>
    <input type="text" id="courseTextbookISBN" placeholder="Enter Textbook ISBN" required>
    <input type="text" id="courseTextbookLink" placeholder="Enter Textbook Website Link" required><br/><br/>
    
    <button onclick="addCourse()">Add Course</button>
    </div>

    <div id="courseList"></div>

    <!-- Modal for Editing -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">Back</button>
            <h2 id="modalTitle">Edit</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Modal for Question Selection -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeQuestionModal()">Back</button>
            <h2 id="questionModalTitle">Select Questions</h2>
            <div id="questionModalBody"></div>
        </div>
    </div>
	

    <script>

var masterQuestionList = {};
var masterTestList = {};
var masterTemplateList = {};
var masterAttachmentList = {};


function addCourse() {
    const courseID = document.getElementById('courseID').value.trim();
    const courseName = document.getElementById('courseName').value.trim();
    const courseCRN = document.getElementById('courseCRN').value.trim();
    const courseSemester = document.getElementById('courseSemester').value;
	const textbookTitle = document.getElementById('courseTextbookTitle').value.trim();
    const textbookAuthor = document.getElementById('courseTextbookAuthor').value.trim();
    const textbookVersion = document.getElementById('courseTextbookVersion').value.trim();
    const textbookISBN = document.getElementById('courseTextbookISBN').value.trim();
    const textbookLink = document.getElementById('courseTextbookLink').value.trim();
            

            if (!courseID || !courseName || !courseCRN || !courseSemester || !textbookTitle || !textbookAuthor || !textbookISBN || !textbookVersion || !textbookLink) {
                alert("All fields (Course ID, Name, CRN, Semester, and Textbook Title/Author/Version/ISBN/Link) are required.");
                return;
            }

            const courseContainer = document.createElement('div');
            courseContainer.classList.add('course-container');
            courseContainer.innerHTML = `
                <details>
                    <summary><strong>${courseName}</strong> (ID: ${courseID}, CRN: ${courseCRN}, ${courseSemester})</summary>

                    <details>
                        <summary>Questions</summary>
                        <button class="add-btn" onclick="openEditor('Question', '${courseID}')">Add Question</button>
                        <div class="tab-container">
                            <div class="tabs">
                                <div class="tab active" onclick="switchTab(event, 'tf-${courseID}')">True/False</div>
				<div class="tab" onclick="switchTab(event, 'mc-${courseID}')">Multiple Choice</div>
                                <div class="tab" onclick="switchTab(event, 'sa-${courseID}')">Short Answer</div>
				<div class="tab" onclick="switchTab(event, 'es-${courseID}')">Essay</div>
                                <div class="tab" onclick="switchTab(event, 'ma-${courseID}')">Matching</div>
				<div class="tab" onclick="switchTab(event, 'ms-${courseID}')">Multiple Selection</div>
				<div class="tab" onclick="switchTab(event, 'fb-${courseID}')">Fill in the Blank</div>
				
                            </div>
                            <div class="tab-content active" id="tf-${courseID}">
                                <p>True/False questions go here...</p>
                            </div>
                            <div class="tab-content" id="es-${courseID}">
                                <p>Essay questions go here...</p>
                            </div>
                            <div class="tab-content" id="mc-${courseID}">
                                <p>Multiple Choice questions go here...</p>
                            </div>
                            <div class="tab-content" id="sa-${courseID}">
                                <p>Short Answer questions go here...</p>
                            </div>
                            <div class="tab-content" id="ma-${courseID}">
                                <p>Matching questions go here...</p>
                            </div>
                            <div class="tab-content" id="ms-${courseID}">
                                <p>Multiple Selection questions go here...</p>
                            </div>
                            <div class="tab-content" id="fb-${courseID}">
                                <p>Fill in the Blank questions go here...</p>
                            </div>
                                                 
                        </div>
                    </details>

                    <details>
                        <summary>Tests</summary>
                        <button class="add-btn" onclick="openEditor('Test', '${courseID}')">Add Test</button>
                        <button class="add-btn" onclick="openImporter('Test', '${courseID}')">Import Test</button>
                        <p>You have not added any tests yet...</p>
                    </details>

                    <details>
                        <summary>Templates</summary>
                        <button class="add-btn" onclick="openEditor('Template', '${courseID}')">Add Template</button>
                        <p>You have not added any templates yet...</p>
                    </details>

                    <details>
                        <summary>Attachments</summary>
                        <button class="add-btn" onclick="openEditor('Attachment', '${courseID}')">Add Attachment</button>
                        <p>You have not uploaded any attachments yet...</p>
                    </details>

                    <button class="remove-btn" onclick="confirmRemoveCourse(this)">Remove Course</button>
                </details>
            `;

            document.getElementById('courseList').appendChild(courseContainer);
            document.getElementById('courseID').value = "";
            document.getElementById('courseName').value = "";
            document.getElementById('courseCRN').value = "";
            document.getElementById('courseSemester').value = "";
	        document.getElementById('courseTextbookTitle').value = "";
            document.getElementById('courseTextbookAuthor').value = "";
            document.getElementById('courseTextbookVersion').value = "";
            document.getElementById('courseTextbookISBN').value = "";
	    document.getElementById('courseTextbookLink').value = "";
	const questionList = {
	    'course': courseID,
	    'tf': [],
	    'mc': [],
	    'sa': [],
	    'es': [],
	    'ma': [],
	    'ms': [],
	    'fb': []
	}
    const testList = {
        'draft': [],
        'published': []
    }

	masterQuestionList[courseID] = questionList;
    masterTestList[courseID] = testList;

}

function confirmRemoveCourse(button) {
    if (confirm("Are you sure you want to delete this course? This action cannot be undone.")) {
        button.closest('.course-container').remove();
    }
}

function switchTab(event, tabID) {
            const parentContainer = event.target.closest('.tab-container');
            const tabs = parentContainer.querySelectorAll('.tab');
            const contents = parentContainer.querySelectorAll('.tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabID).classList.add('active');
}

function openEditor(type, courseID) {
    const modal = document.getElementById('editModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    modalTitle.innerText = `Add ${type}`;

    let formContent = '';    

    if (type != "Question"){
        formContent += `
	<label>${type} Name:</label><br/>
        <input type="text" id="nameField"><br><br>
    `;
    }
    

    if (type === "Question") {
        formContent += `
            <label>Question:</label><br/>
            <textarea id="questionField" rows="5" placeholder="Enter question text here..."></textarea><br><br>
            
            <label>Question Type:</label><br/>
            <select id="typeField">
                <option value="" disabled selected>Select Question Type</option>
                <option value="tf">True/False</option>
                <option value="mc">Multiple Choice</option>
                <option value="sa">Short Answer</option>
                <option value="es">Essay</option>
                <option value="ma">Matching</option>
                <option value="ms">Multiple Selections</option>
                <option value="fb">Fill in the Blank</option>
            </select><br><br>

            <label>Correct Answer:</label><br/>
            <textarea id="answerField" rows="4" placeholder="For questions that lack a correct answer, please repeat the prompt here."></textarea><br><br>

            <label>Point Value:</label><br/>
            <input type="number" id="pointValueField" min="1"><br><br>

	    <label>Estimated Time to Solve (Minutes):</label><br/>
            <input type="number" id="qTimeField" min="1"><br><br>

            <label>Grading Instructions:</label><br/>
            <textarea id="instructionField" rows="6" placeholder="Grading instructions should be provided for partial credit, short or long answer questions, or questions where a rubric is necessary."></textarea><br><br>

            <label>Reference Text (Optional):</label><br/>
            <textarea id="refField" rows="3" placeholder="Reference text if needed..."></textarea><br><br>

	    <label>Embedded Graphic (Optional):</label><br/>
            <input type="file" id="qGraphicField" name="questionSRC"></input><br><br>
	
	    <label>Embedded Graphic for the Correct Answer (Optional):</label><br/>
            <input type="file" id="ansGraphicField" name="answerSRC"></input><br><br>
        
        <label>Instructor Comments (Optional):</label><br/>
            <textarea id="instructorCommentField" placeholder="Comments go here"></textarea><br><br>

            <button class="add-btn" onclick="addQuestion('${courseID}')">Submit Question</button>
        `;
    }

    if (type === "Test"){
        formContent+= `
        <div style="background:#e0e0e0;padding:20px;" id="testEditor">
            <p>Choose a Template!</p><br/>
            <div id=templateSelectorPane>
                <select id=templateSelector>
                    <option value="" disabled selected>Please Select a Template</option>
                </select> <button id=templateSelection onclick="updateTestParts('${courseID}')">Select This One!</button>
                <div id="testParts"> </div>
            </div>
            <button class="add-btn" id="testDraftButton" onclick="saveTest('${courseID}', '${false}')">Save as Draft</button>
            <button class="add-btn" id="testPublishButton" onclick="saveTest('${courseID}', '${true}')">Publish Test</button>
        </div>
        `;
        setTimeout(() => {
        updateTemplateSelection(courseID);
    }, 50);
        
    }


     if (type === "Template") {
        formContent += `
            <div  style="background:#e0e0e0;padding:20px;" id="templateEditor"> 
	    <h1>Font Settings</h1>
  	    <label>Title Font and Font Size:</label><br/>
	    <input type="text" id="titleFont" placeholder="Enter Title Font...">
	    <input type="number" id="titleFontSize" min="1" value="36"><br/><br/>
	    <label>Subtitle Font and Font Size:</label><br/>
	    <input type="text" id="subtitleFont" placeholder="Enter Subtitle Font...">
	    <input type="number" id="subtitleFontSize" min="1" value="24"><br/><br/>
    	    <label>Body Font and Font Size:</label><br/>
	    <input type="text" id="bodyFont" placeholder="Enter Body Font...">
	    <input type="number" id="bodyFontSize" min="1" value="12"><br/><br/>
        
        <h1>Tags Section (Optional)</h1>
        <label>Test Name </label> <input type="text" id="tempTestName"><br/>
        <label>Date </label> <input type="text" id="tempDate"><br/>
        <label>Course Number </label> <input type="text" id="tempCourseNum"><br/>

  	    <h1>Header and Footer Settings</h1>
        <label>Location of Student Score Blank</label><br/>
        <select id="studentScoreSelector">
            <option value="" disabled selected>Please Select a Location</option>
            <option value="TR"> Top Right</option>
            <option value="TL"> Top Left</option>
        </select>
	    <label>Page Numbers in Header</label><br/>
	    <input type="checkbox" id="pageNumH"><br/>
	    <label>Page Numbers in Footer</label><br/>
	    <input type="checkbox" id="pageNumF"><br/><br/>
	    <textarea id="headerField" rows="3" placeholder="Enter any desired header text ..."></textarea>
	    <textarea id="footerField" rows="3" placeholder="Enter any desired footer text..."></textarea>
	    
	    <h1>Cover Page Selection</h1><br/>
	    <select id="coverPageSelector">
		<option value="" disabled selected>Please Select a Cover Page</option>
		<option value="CPT1">Cover Page Template 1</option>
		<option value="CPT2">Cover Page Template 2</option>
		<option value="CPT3">Cover Page Template 3</option>
		<option value="CPTC">Cover Page Custom Upload</option>
	    </select><br/><br/>
	    <label>Custom Cover Page (Optional)</label><br/>
	    <input type=file id="coverPageUploader"><br/><br/>

	    <h1>Test Structure Settings</h1>
	    <label>Number of Parts:</label>
            <input type="number" id="partCount" min="1" value="1">
            <button onclick="updateParts()">Update</button>
            <div style="background:#d0d0d0;padding:20px" id="partsContainer"><p>No Parts Chosen</p></div>
            
	    <!-- I may add a button to allow for selection of specific bonus questions as part of the template later -->
	    <h1>Bonus Question Section Toggle</h1>
	    <select id="bonusToggle">
		<option value="True">Bonus Section</option>
		<option value="False">No Bonus Section</option>
	    </select><br/><br/>

        <button class="add-btn" onclick="addTemplate('${courseID}')">Submit Template</button></div>

	    
        `;
    }


    if (type === "Attachment"){
        formContent+=`
            <input type="file" id="newAttachment" name="attachment">
	        <button class="add-btn" onclick="submitAttachment('${courseID}')">Submit Attachment</button>
        `;
   }

    // Ensure the modal content is updated
    modalBody.innerHTML = formContent;

    // Show the modal
    modal.style.display = "flex";
    setTimeout(() => {
        modal.style.opacity = "1";
    }, 10);
}

function submitAttachment(courseID){
    const attachment = document.getElementById("newAttachment").files[0];
    const name = document.getElementById("nameField").value.trim();
    if(!masterAttachmentList[courseID]){
        masterAttachmentList[courseID] = [];
    }
    masterAttachmentList[courseID].push(attachment);
}

function addTemplate(courseID){
    const templateName = document.getElementById('nameField').value.trim();
    const coverPageType = document.getElementById('coverPageSelector').value;
    
    if (!templateName) {
        alert("Template Name is required.");
        return;
    }

    const templateData = {
        name: templateName,
        titleFont: document.getElementById('titleFont').value,
        titleFontSize: document.getElementById('titleFontSize').value,
        subtitleFont: document.getElementById('subtitleFont').value,
        subtitleFontSize: document.getElementById('subtitleFontSize').value,
        bodyFont: document.getElementById('bodyFont').value,
        bodyFontSize: document.getElementById('bodyFontSize').value,
        pageNumbersInHeader: document.getElementById('pageNumH').checked,
        pageNumbersInFooter: document.getElementById('pageNumF').checked,
        headerText: document.getElementById('headerField').value,
        footerText: document.getElementById('footerField').value,
        coverPageType: coverPageType,
        partStructure: collectPartStructure(),
        bonusSection: document.getElementById('bonusToggle').value === 'True'
    };

    if (coverPageType === 'CPTC') {
        templateData.coverPageImg = document.getElementById('coverPageUploader').files[0];
    }

    if (!masterTemplateList[courseID]) {
        masterTemplateList[courseID] = [];
    }
    
    masterTemplateList[courseID].push(templateData);
    
    alert("Template added successfully!");
    console.log("Saved Template:", templateData);

    closeModal();
}

function collectPartStructure() {
    const partCount = parseInt(document.getElementById('partCount').value);
    const partStructure = [];
    
    for (let i = 1; i <= partCount; i++) {
        const part = {
            partNumber: i,
            sections: []
        };
        
        const sectionCount = parseInt(document.getElementById(`sectionCount-${i}`).value);
        const sectionContainer = document.getElementById(`sectionsContainer-${i}`);
        const sectionSelects = sectionContainer.querySelectorAll('select');
        
        sectionSelects.forEach((select, j) => {
            part.sections.push({
                sectionNumber: j + 1,
                questionType: select.value
            });
        });
        
        partStructure.push(part);
    }
    
    return partStructure;
}

function updateTemplateSelection(courseID){
    if(!masterTemplateList[courseID]){
            masterTemplateList[courseID] = [];
        }else if(!masterTemplateList[courseID][0]){
            alert("No templates available for this course!");
        }else{
            const templateList = masterTemplateList[courseID];
            templateList.forEach((template, index)=>{
            const selection = document.getElementById("templateSelector");
            const newoption = document.createElement("option");
            newoption.value = index;
            newoption.textContent= template.name;
            selection.appendChild(newoption);
        });
        }
}

function addQuestion(courseID) {
    const prompt = document.getElementById("questionField").value.trim();
    const solution = document.getElementById("answerField").value.trim();
    const type = document.getElementById("typeField").value;
    const points = document.getElementById("pointValueField").value.trim();
    const instructions = document.getElementById("instructionField").value.trim();
    const refText = document.getElementById("refField").value.trim();
    const time = document.getElementById("qTimeField").value.trim();
    const graphic = document.getElementById("qGraphicField").value;
    const ansgraphic = document.getElementById("ansGraphicField").value;
    const instcomm = document.getElementById("instructorCommentField").value;


    if (!prompt || !solution || !type || !points || !instructions || !time) {
        alert("Some fields (Question, Question Type, Correct Answer, Default Point Value, and Grading Instructions) are required.");
        return;
    }

    const question = {
	text: prompt,
	answer: solution,
	qtype: type,
	score: points,
	directions: instructions,
	reference: refText,
	eta: time,
	img: graphic,
	ansimg: ansgraphic,
    comments: instcomm,
    tests: []
	}
    masterQuestionList[courseID][type].push(question);
    lastquestion = masterQuestionList[courseID][type].length-1;
    updateTabs(type, courseID);
    alert("Added the " + masterQuestionList[courseID][type][lastquestion].qtype.toUpperCase() + " Question: \n\"" + masterQuestionList[courseID][type][lastquestion].text + "\"\n (Worth " + masterQuestionList[courseID][type][lastquestion].score + " points!)");

    closeModal();
}

function updateTestParts(courseID) {
    const templateIndex = document.getElementById("templateSelector").value;
    if (!templateIndex) {
        alert("Please select a template first");
        return;
    }
    
    const template = masterTemplateList[courseID][templateIndex];
    const partStructure = template.partStructure;
    
    let test = document.getElementById("testParts");
    test.innerHTML = ""; // Clear existing content

    // Loop through each part in the template structure
    for (let i = 0; i < partStructure.length; i++) {
        let partContainer = document.createElement("div");
        partContainer.style.padding = '5px';
        partContainer.style.marginBottom = '8px';
        partContainer.style.borderBottom = '1px solid #ccc';
        partContainer.id = `part-${i}-container`;

        let partNum = i + 1;
        partContainer.innerHTML = `<h2>Part ${partNum}</h2>`;

        // Loop through each section in this part
        const sections = partStructure[i].sections;
        for (let j = 0; j < sections.length; j++) {
            let sectionContainer = document.createElement('div');
            sectionContainer.style.padding = '5px';
            sectionContainer.style.marginBottom = '8px';
            sectionContainer.style.borderBottom = '1px solid #ccc';
            sectionContainer.style.backgroundColor = '#d3d3d3';
            sectionContainer.id = `part-${i}-section-${j}-container`;

            let sectionNum = j + 1;
            const questionType = sections[j].questionType.toLowerCase();

            sectionContainer.innerHTML = `
                <h3>Section ${sectionNum}: ${questionType.toUpperCase()} Questions</h3>
                <button class="add-btn" onclick="openQuestionModal('${courseID}', ${i}, ${j}, '${questionType}')">Choose Questions</button>
                <div class="selected-questions"></div>
            `;

            partContainer.appendChild(sectionContainer);
        }

        test.appendChild(partContainer);
    }
}

function saveTest(courseID, isPublished) {
    const testName = document.getElementById("nameField").value.trim();
    if (!testName) {
        alert("Test Name is required.");
        return;
    }
    
    const templateIndex = document.getElementById("templateSelector").value;
    if (!templateIndex) {
        alert("Please select a template first");
        return;
    }
    
    const template = masterTemplateList[courseID][templateIndex];
    
    const testData = {
        name: testName,
        template: template.name,
        templateIndex: templateIndex,
        parts: []
    };
    
    // Loop through all parts and sections rendered in the UI
    const testParts = document.getElementById("testParts");
    const partContainers = testParts.querySelectorAll('[id^="part-"][id$="-container"]');
    
    partContainers.forEach((partContainer, partIndex) => {
        const partData = {
            partNumber: partIndex + 1,
            sections: []
        };
        
        // Find all section containers within this part
        const sectionContainers = partContainer.querySelectorAll('[id^="part-' + partIndex + '-section-"]');
        
        sectionContainers.forEach((sectionContainer, sectionIndex) => {
            const questionType = template.partStructure[partIndex].sections[sectionIndex].questionType;
            const selectedQuestionsDiv = sectionContainer.querySelector('.selected-questions');
            
            // Skip sections with no questions
            if (!selectedQuestionsDiv || !selectedQuestionsDiv.children.length) {
                return;
            }
            
            const sectionData = {
                sectionNumber: sectionIndex + 1,
                questionType: questionType,
                questions: []
            };
            
            // Get all question divs (skip the first child which is the section points setter)
            const questionDivs = selectedQuestionsDiv.querySelectorAll('div[style*="border-radius"]');
            
            questionDivs.forEach((questionDiv) => {
                const questionIndex = questionDiv.dataset.questionIndex;
                const pointsInput = questionDiv.querySelector('.question-points');
                const points = pointsInput ? parseInt(pointsInput.value) : 1;
                
                // Get the question from master list and clone it
                const question = JSON.parse(JSON.stringify(masterQuestionList[courseID][questionType.toLowerCase()][questionIndex]));
                
                // Update points if they were changed
                question.score = points;
                
                // Add to the questions for this section
                sectionData.questions.push(question);
            });
            
            partData.sections.push(sectionData);
        });
        
        testData.parts.push(partData);
    });
    
    // Save the test data
    if (!masterTestList[courseID]) {
        masterTestList[courseID] = { draft: [], published: [] };
    }
    
    const targetList = isPublished === 'true' ? masterTestList[courseID].published : masterTestList[courseID].draft;
    targetList.push(testData);
    
    alert(`Test "${testName}" saved successfully as ${isPublished === 'true' ? "Published" : "Draft"}!`);
    closeModal();
}

function openQuestionModal(courseID, partNum, sectionNum, type) {
    const modal = document.getElementById("questionModal");
    const modalTitle = document.getElementById("questionModalTitle");
    const modalBody = document.getElementById("questionModalBody");
    
    // Check if we have questions of this type
    if (!masterQuestionList[courseID][type] || masterQuestionList[courseID][type].length === 0) {
        alert("No questions available of this type!");
        return;
    }

    const questions = masterQuestionList[courseID][type];
    modalBody.innerHTML = ""; // Clear existing content

    // Store the part/section info in the modal for later use
    modalBody.dataset.courseId = courseID;
    modalBody.dataset.partNum = partNum;
    modalBody.dataset.sectionNum = sectionNum;
    modalBody.dataset.questionType = type;

    const questionContainer = document.createElement('div');
    questionContainer.style.padding = '5px';
    questionContainer.style.marginBottom = '8px';
    questionContainer.style.borderBottom = '1px solid #ccc';

    questions.forEach((question, index) => {
        const element = document.createElement("div");
        element.style.padding = '8px';
        element.style.margin = '5px 0';
        element.style.backgroundColor = '#f0f0f0';
        element.style.borderRadius = '4px';
        element.innerHTML = `
            <input type="checkbox" id="q-${index}" value="${index}">
            <label for="q-${index}">${question.text} (${question.score} Points)</label>
        `;   
        questionContainer.appendChild(element);
    });

    const submitButton = document.createElement('button');
    submitButton.className = 'add-btn';
    submitButton.textContent = 'Add Selected Questions';
    submitButton.onclick = function() {
        addSelectedQuestions();
    };
    questionContainer.appendChild(submitButton);

    modalTitle.innerText = `Select ${type.toUpperCase()} Questions`;
    modalBody.appendChild(questionContainer);

    modal.style.display = "flex";
    setTimeout(() => {
        modal.style.opacity = "1";
    }, 10);
}

function addSelectedQuestions() {
    const modalBody = document.getElementById("questionModalBody");
    const courseID = modalBody.dataset.courseId;
    const partNum = parseInt(modalBody.dataset.partNum);
    const sectionNum = parseInt(modalBody.dataset.sectionNum);
    const type = modalBody.dataset.questionType;
    
    const checkboxes = document.querySelectorAll('#questionModalBody input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
        alert("Please select at least one question.");
        return;
    }
    
    const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
    const questions = selectedIndices.map(index => masterQuestionList[courseID][type][index]);
    
    // Update the test part on screen
    const sectionContainer = document.getElementById(`part-${partNum}-section-${sectionNum}-container`);
    const selectedQuestionsDiv = sectionContainer.querySelector('.selected-questions');
    selectedQuestionsDiv.innerHTML = '';
    
    // Create a section-wide point value input
    const sectionPointsDiv = document.createElement("div");
    sectionPointsDiv.innerHTML = `
        <label>Set All Points for This Section: </label>
        <input type="number" id="section-${partNum}-${sectionNum}-points" min="1" value="1" style="width: 60px;">
        <button onclick="updateSectionPoints(${partNum}, ${sectionNum})">Apply</button>
        <hr>
    `;
    selectedQuestionsDiv.appendChild(sectionPointsDiv);

    // Add each selected question to the section
    questions.forEach((question, index) => {
        const questionElement = document.createElement("div");
        questionElement.style.padding = "8px";
        questionElement.style.margin = "5px 0";
        questionElement.style.backgroundColor = "#f0f0f0";
        questionElement.style.borderRadius = "4px";
        questionElement.dataset.questionIndex = selectedIndices[index]; // Store original index

        questionElement.innerHTML = `
            <p>${question.text}</p>
            <label>Points: </label>
            <input type="number" class="question-points" min="1" value="${question.score}" style="width: 60px;">
        `;

        selectedQuestionsDiv.appendChild(questionElement);
    });

    alert(`Added ${questions.length} questions to Part ${partNum + 1}, Section ${sectionNum + 1}`);

    closeQuestionModal();
}

function updateSectionPoints(partNum, sectionNum) {
    const newPointValue = document.getElementById(`section-${partNum}-${sectionNum}-points`).value;

    if (!newPointValue || newPointValue < 1) {
        alert("Please enter a valid point value.");
        return;
    }

    // Select all question inputs in this section
    const sectionContainer = document.getElementById(`part-${partNum}-section-${sectionNum}-container`);
    const pointInputs = sectionContainer.querySelectorAll('.question-points');

    pointInputs.forEach(input => {
        input.value = newPointValue;
    });

    alert(`Updated all questions in Part ${partNum + 1}, Section ${sectionNum + 1} to ${newPointValue} points each.`);
}

function updateParts() {
    const partCount = parseInt(document.getElementById("partCount").value);
    const partsContainer = document.getElementById("partsContainer");
    partsContainer.innerHTML = ""; // Clear existing content

    for (let i = 1; i <= partCount; i++) {
        let sectionInputId = `sectionCount-${i}`;
        partsContainer.innerHTML += `
            <div id="part-${i}">
                <label>Sections in Part ${i}:</label>
                <input type="number" id="${sectionInputId}" min="1" value="1">
                <button onclick="updateSections(${i})">Update</button>
                <div style="background:#c0c0c0;padding:20px;" id="sectionsContainer-${i}"><p>No Sections Chosen...</p></div>
            </div><br>
        `;
    }
}

function updateSections(partNumber) {
    const sectionCount = parseInt(document.getElementById(`sectionCount-${partNumber}`).value);
    const sectionsContainer = document.getElementById(`sectionsContainer-${partNumber}`);
    sectionsContainer.innerHTML = ""; // Clear old sections

    for (let j = 1; j <= sectionCount; j++) {
        sectionsContainer.innerHTML += `
            <label>Question Type for Section ${j}:</label>
            <select>
                <option value="TF">True/False</option>
                <option value="MC">Multiple Choice</option>
                <option value="SA">Short Answer</option>
                <option value="ES">Essay</option>
                <option value="MA">Matching</option>
                <option value="MS">Multiple Selections</option>
                <option value="FB">Fill in the Blank</option>
            </select><br>
        `;
    }
}

function updateTabs(type, courseID) {
  const tabContent = document.getElementById(`${type}-${courseID}`);
  tabContent.innerHTML = '';
  const questionList = masterQuestionList[courseID][type];
  if (questionList.length === 0) {
    tabContent.innerHTML = '<p>No questions available...</p>';
    return;
  }
  
  questionList.forEach((question, index) => {
    const questionContainer = document.createElement('div');
    questionContainer.style.padding = '5px';
    questionContainer.style.marginBottom = '8px';
    questionContainer.style.borderBottom = '1px solid #ccc';
    
    const questionElement = document.createElement('p');
    questionElement.textContent = `${question.text} (Worth ${question.score} points)`;
    
    questionContainer.appendChild(questionElement);
    tabContent.appendChild(questionContainer);
  });
}

function updateSemesterOptions() {
    const select = document.getElementById('courseSemester');
    select.innerHTML = ''; // Clear existing options
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Please Choose a Semester';
    option.disabled=true;
    select.appendChild(option);
    option.selected=true;


    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1; 
    let N, N_plus_1;
    if (month <= 5) {
        N = year - 1;
        N_plus_1 = year;
    } else {
        N = year;
        N_plus_1 = year + 1;
    }

    const semesters = [
        `Fall ${N}`,
        `Winter ${N}`,
        `Spring ${N_plus_1}`,
        `Summer ${N_plus_1}`
    ];

    semesters.forEach(semester => {
        const option = document.createElement('option');
        option.value = semester;
        option.textContent = semester;
        select.appendChild(option);
    });
}

window.onbeforeunload = function(event){
    event.returnValue = "Warning!";
};

function closeModal() {
            document.getElementById("editModal").style.display = "none";
    document.getElementById("editModal").style.opacity = "0";
        }

function closeQuestionModal(){
            document.getElementById("questionModal").style.display = "none";
    document.getElementById("questionModal").style.opacity = "0";
        }

document.addEventListener("DOMContentLoaded", updateSemesterOptions);



</script>

</body>
</html>