{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Manage Website</title>
<link rel="shortcut icon" href="{% static '\welcome\quizpress.ico' %}" type="image/x-icon">
<link rel="icon"        href="{% static '\welcome\quizpress.ico' %}" type="image/x-icon">
    <style>
        /* Input fields */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
        margin-bottom: 8px;
            height: 40px !important;
            padding: 10px 12px !important;
            font-size: 16px !important;
            border: 1px solid #ccc !important;
            border-radius: 8px !important;
            transition: all 0.3s ease;
            min-width: 200px !important;
        }
    
        /* Focus states */
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            border-color: #0077C8 !important;
            box-shadow: 0 0 0 2px rgba(0, 119, 200, 0.1) !important;
            outline: none !important;
        }
    
        .dual-container {
            display: flex;
            gap: 40px;
            margin-top: 30px;
            align-items: flex-start;
        }
    
        /* Dropdown specific */
        select {
            select#courseSemester {
                background-color: #ffffff !important;
                border-color: #cccccc !important;
            }
            
            /* Custom dropdown arrow - ensure visibility */
            select#courseSemester {
                background-image: url("data:image/svg+xml;utf8,<svg fill='%23666' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") !important;
            }
        }
    
        /* Textareas */
        textarea {
            height: auto !important;
            min-height: 120px !important;
            line-height: 1.5 !important;
        }
    
        /* Error message */
        #errorText {
            color: #dc3545 !important;
            font-size: 14px !important;
            margin-top: 8px !important;
            padding: 8px 12px !important;
            border-radius: 6px !important;
            background-color: #f8d7da !important;
            border: 1px solid #f5c6cb !important;
        }
    
        /* Hover states */
        input:hover,
        select:hover,
        textarea:hover {
            border-color: #999 !important;
        }
    
            /* Base styles */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
    
            body {
                font-family: Arial, sans-serif;
                color: #333;
                background: #f5f7fa;
            }
    
            /* Header Styles */
            .header {
                background-color: #0077C8;
                color: white;
                padding: 25px 0;
                text-align: center;
            }
    
            .header h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
            }
    
            .welcome-bar {
                background-color: #005fa3;
                padding: 15px 0;
                text-align: center;
                color: white;
                font-size: 1.2rem;
                letter-spacing: 0.5px;
            }
    
            /* Main Content Container */
            .container {
                max-width: 1200px;
                margin: 2rem auto 0 auto;
                padding: 0 20px;
            }
    
            .user-info-container {
                width: 100%;
                max-width: 1200px;
                margin: 30px auto;
                display: flex;
                justify-content: center;
                }

                .course-form {
                width: 100%;
                padding: 30px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                }
    
            .course-form h2 {
                text-align: center;
                font-size: 2.2rem;
                margin-bottom: 1.5rem;
                color: #2e3a42;
                font-weight: 700;
                border-bottom: 2px solid #0077C8;
                padding-bottom: 10px;
            }
    
            .course-container {
                background: #ffffff;
                border: 1px solid #d9d9d9;
                border-radius: 12px;
                padding: 5px 30px;
                margin: 30px auto;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
                width: 120%;
                max-width: 1000px;
                transition: all 0.3s ease;
            }
    
            .course-container:hover {
                transform: translateY(-5px);
                box-shadow: 0 12px 24px rgba(0,0,0,0.12);
            }

            .course-container details[open] {
                width: 100% !important;
                max-width: none !important;
                padding: 20px !important;
                box-sizing: border-box;
            }
            
            /* Consistent details styling */
            .course-container details {
                background: #f8f9fa !important;
                border-radius: 8px !important;
                margin: 12px 0 !important;
                border: 1px solid #dee2e6 !important;
                transition: all 0.3s ease; /* Add transition */
            }
    
            .course-container details:hover {
                transform: translateY(-3px); /* Slight lift */
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); /* Stronger shadow */
            }
            
            /* Summary element styling */
            .course-container details summary {
                padding: 14px !important;
                font-weight: 600 !important;
                color: #2e3a42 !important;
                cursor: pointer !important;
            }
            
            /* Nested elements consistency */
            .course-container details details {
                background: #ffffff !important;
                margin: 8px 0 !important;
            }


            .course-container details details[open] {
                width: 100% !important;
                padding: 16px !important;
            }
            
            /* Remove button styling */
            .course-container .remove-btn {
                margin-top: 20px !important;
                width: 100% !important;
                padding: 12px !important;
                font-size: 16px !important;
            }
    
            body { font-family: Arial, sans-serif; }
            textarea {width: 100%;min-height: 100px;resize: vertical;font-size: 16px;padding: 8px;}
            details { margin-top: 10px; padding: 10px; background: #e0e0e0; border-radius: 5px; }
            .remove-btn { background: red; color: white; padding: 8px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;}
            .tab-container .tab.active {
                background-color: #0077C8; /* Blue background for active tab */
                color: white; /* White text for active tab */
                border: 1px solid #0077C8; /* Optional: solid blue border */
            }
            .tabs { display: flex; cursor: pointer; overflow-x: auto;border-bottom: 2px solid #cccccc; }
            .tab { padding: 8px 12px; border: 1px solid #cccccc; border-bottom: none; background: #d9d9d9; }
            .tab.active { background: #ffffff; font-weight: bold; }
            .tab-content {
                display: none;
                background: white; /* white background to match cards */
                padding: 20px;
                margin-top: 10px;
                border: 1px solid #ccc;
                border-radius: 10px; /* rounded corners */
                box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* soft shadow */
                min-height: 120px;
                max-height: 600px;
                overflow-y: auto;
                resize: vertical; /* allow resizing if needed */
                transition: all 0.3s ease;
            }

            .tab-content.active {
                display: block;
            }
            .add-btn { background: #0077C8; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;}
            .save-btn { background: #0066b5; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;}
            .modal {
                display: none;
                position: fixed;
                top: 0; 
                left: 0;
                width: 100%; 
                height: 100%;
                background: rgba(0,0,0,0.5);
                overflow: hidden;
                align-items: center;
                justify-content: center;
                z-index: 1000; /* ⬅️ Add this! */
            }
    
            .modal-content {
                background: white;
                padding: 20px;
                width: 50%;
                max-height: 80vh;
                overflow-y: auto;
                margin: 5% auto;
                border-radius: 10px;
                z-index: 1001; /* ⬅️ Optional: slightly higher than modal background */
            }
            .close-btn { background: red; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer;}
            .form-container {display: flex;flex-direction: column;align-items:left;padding: 20px;width: 300px;}
            .form-group {display: flex;align-items: left;margin-bottom: 10px;width: 100%;}
            .form-group label {width: 120px;text-align: right;margin-right: 10px;}
            .form-group input {flex: 1;}
            .context-menu {display: none;position: fixed;background: white;border: 1px solid #ccc;box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);z-index: 1000;}
            .context-menu ul {list-style: none;margin: 0;padding: 0;}
            .context-menu ul li {padding: 8px 12px;cursor: pointer;}
            .context-menu ul li:hover {background: #f0f0f0;}
            button.loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    
        button {
            transition: all 0.1s ease-in-out;
            transform: scale(1);
        }
    
        button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) inset;
        }
    
        .section-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 12px 0;
            padding: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
    
        .section-item:hover {
            background: #e2f0ff;
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
    
    
            /* Main Course Card summary */
        .course-container > details > summary {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 10;
            padding: 18px;
            font-size: 15px;
            font-weight: bold;
            border-bottom: 2px solid #0077C8;
            cursor: pointer;
        }
    
        /* Subcard (Questions, Cover Pages, Templates) summaries */
        .course-container details > details > summary {
            position: sticky;
            top: 40px;
            background: #f8f9fa;
            z-index: 8;
            padding: 14px;
            font-weight: 600;
            border-bottom: 1px solid #ccc;
            cursor: pointer;
        }
    
    
        
        .course-container details:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            background: #f8f9fa;
        }

        input[type="file"] {
    display: inline-block;
    width: auto;
    font-size: 16px;
    margin-top: 10px;
}

input[type="file"] {
    display: inline-block;
    width: auto;
    font-size: 16px;
    margin-top: 10px;
    overflow: hidden; /* hides "no file chosen" text */
}

input[type="file"]::file-selector-button {
    background-color: #0077C8;
    color: white;
    border: none;
    padding: 6px 8px;
    border-radius: 8px;
    font-size: 14px;
    font-family: Arial, sans-serif; /* match your other button fonts */
    font-weight: normal; /* match font weight */
    cursor: pointer;
    width: 100px; /* fixed width to match others */
    text-align: center;
    transition: background-color 0.3s ease;
}

input[type="file"]::file-selector-button:hover {
    background-color: #005fa3;
}

html, body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  height: auto;
}





</style>
</head>

<body style="margin:0; min-height:100vh; position:relative; overflow-x:hidden;">
    <!-- Background for Vanta Waves -->
    <div id="vanta-bg" style="position:fixed; top:0; left:0; width:100%; height:100vh; z-index:-1;"></div>
  
<div class="header">
    <h1>QuizPress</h1>
    <p>Manage Users</p>
</div>
<div class="welcome-bar">
    Manage User
</div>

<main class="container">
    <div class="course-form">
<style>
        body { font-family: Arial, sans-serif; }
        .error-message{color:red;}   
        textarea {width: 100%;min-height: 100px;resize: vertical;font-size: 16px;padding: 8px;}
        .course-container { background: #f4f4f4; padding: 15px; margin: 15px 0; border-radius: 8px; width: 80%; }
        details { margin-top: 10px; padding: 10px; background: #e0e0e0; border-radius: 5px; }
        .remove-btn { background: red; color: white; padding: 8px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;}
        .form-container {display: flex;flex-direction: column;align-items:left;padding: 20px;width: 300px;}
        .form-group {display: flex;align-items: left;margin-bottom: 10px;width: 100%;}
        .form-group label {width: 120px;text-align: right;margin-right: 10px;}
        .form-group input {flex: 1;}


        



        
    </style>
</head>
<div class="textbook-form">
<h3>Choose your Search Query</h3>

<divclass="textbook-container">
<select id="searchSelector" onchange="updateSearchInput()">
<option value="UN">Search by Username</option>
<option value="ID">Search for User ID</option>
</select>
<div id="searchInput">
<input id="searchField" placeholder="Enter Username" type="text"/>
</div>
<button class="add-btn cool-press" onclick="filterSearch()">Filter</button>
<div id="searchContent"></div>
</div>

<div style="margin-bottom: 10px;">
    <button class="add-btn cool-press" onclick="openPreviewMenu()">Export Database</button>
</div>
<div>
    <button class="add-btn cool-press" onclick="openImportMenu()">Import</button>
</div>

<div style="text-align: center; margin-top: 40px;">
    <form action="{% url 'home' %}" method="get">
      <button type="submit" style="
        background-color: red;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s ease, transform 0.2s ease;
      "
      onmouseover="this.style.backgroundColor='#cc0000'; this.style.transform='scale(1.05)'"
      onmouseout="this.style.backgroundColor='red'; this.style.transform='scale(1)'">
        Logout
      </button>
    </form>
  </div>

</div>



<script>

function flattenQuestionList(questionList) {
    let flat = {};
    for (const courseID in questionList) {
        for (const qtype in questionList[courseID]) {
            for (const qid in questionList[courseID][qtype]) {
                flat[qid] = questionList[courseID][qtype][qid];
            }
        }
    }
    return Object.values(flat);
}

function flattenTestList(testList) {
    let flat = {};
    for (const identity in testList) {
        for (const published in testList[identity]) {
            for (const id in testList[identity][published]) {
                flat[id] = testList[identity][published][id];
            }
        }
    }
    return Object.values(flat);
}

function flattenByCourse(dataObj) {
    let flatList = [];
    for (const courseID in dataObj) {
        for (const itemID in dataObj[courseID]) {
            flatList.push(dataObj[courseID][itemID]);
        }
    }
    return flatList;
}



    var userQuestions = {};
    var userTests = {};
    var userCoverPages = {};
    var userTemplates ={};
    var userAttachments ={};
    var username;
    var password;

    async function filterSearch() {
        const searchType = document.getElementById("searchSelector").value;
        const searchValue = document.getElementById("searchField").value.trim();

        if (!searchValue) {
            alert("Please enter a search value.");
            return;
        }

        const requestData = {
            type: searchType,
            value: searchValue
        };

        try {
            const response = await fetch('/api/fetch_user_data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(requestData)
            });
            const data = await response.json();

            if (response.ok) {
                if(data.role!="webmaster"){
                    renderUserData(data);
                }else{
                    document.getElementById('searchContent').innerText = 'Please edit webmaster account info in the shell.';
                }
            } else {
                document.getElementById('searchContent').innerText = data.message || 'An error occurred.';
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('searchContent').innerText = 'An error occurred while fetching data.';
        }
    }

    function updateSearchInput() {
        const searchType = document.getElementById("searchSelector").value;
        const searchField = document.getElementById("searchField");

        searchField.placeholder = searchType === "UN" ? "Enter Username" : "Enter User ID";
    }

    function renderUserData(data) {
        console.log("Full user data received:", data);
        console.log("Flattened questions:", userQuestions);
        console.log("Parsed tests:", sortList(data.test_list, "test"));
        console.log("Parsed templates:", sortList(data.template_list, ""));
        console.log("Parsed coverpages:", sortList(data.cpage_list, ""));
        console.log("Parsed attachments:", sortList(data.attachment_list, ""));

        role = data.role;
        username = data.username;
        password = data.password;


        userQuestions = flattenQuestionList(data.question_list);
        userTests = flattenTestList(data.test_list);
        userTemplates = flattenByCourse(data.template_list);
        userCoverPages = flattenByCourse(data.cpage_list);
        userAttachments = flattenByCourse(data.attachment_list);





        const container = document.getElementById('searchContent');
container.innerHTML = `
    <div class="user-info-container">
      <div class="course-form">
        <div class="course-container">
          <details open>
            <summary>User Information</summary>
            <div class="form-container">
                <label>Enter New Username for ${username}</label>
                <input id="unchange" type="text" value="${data.username}">
                <input type="checkbox" id="checkUN">
                <label>Enter New Password:</label>
                <input id="pwchange" type="text">
                <input type="checkbox" id="checkPW">
                <p style="margin-top:10px;">Check the box of either (or both) field(s) you wish to update</p>
                <button class="add-btn cool-press" onclick="updateUserData()">Update User Data</button>

            </div>
        </details>
        <details>
            <summary>Questions</summary>
            <div id="question-container">No questions yet. . .</div>
        </details>
        <details>
            <summary>Tests</summary>
            <div id="test-container">No tests yet. . .</div>
        </details>
        <details>
            <summary>Coverpages</summary>
            <div id="coverpage-container">No cover pages yet. . .</div>
        </details>
        <details>
            <summary>Templates</summary>
            <div id="template-container">No templates yet. . .</div>
        </details>
        <details>
            <summary>Attachments</summary>
            <div id="attachment-container">No attachments yet. . .</div>
        </details>
    </div>
    </div>
`;

        questionContainer = document.getElementById("question-container");
        if (userQuestions.length === 0) {
            questionContainer.innerHTML = "No questions yet...";
        } else {
            questionContainer.innerHTML = ""; // Clear container
        for(let i=0; i<userQuestions.length; i++) {
            let div = document.createElement("div");
            div.className = "course-container";
            let p = document.createElement("p");
            p.innerHTML = `Question: ${userQuestions[i].text}`;
            div.appendChild(p);

            // Add delete button
            let deleteBtn = document.createElement("button");
            deleteBtn.className = "remove-btn";
            deleteBtn.textContent = "Delete Question";
            deleteBtn.onclick = function() { deleteItem(this); };
            div.appendChild(deleteBtn);

            div.dataset.index = i;
            div.dataset.type = "question";
            questionContainer.appendChild(div);
            }
        }

        // Similar updates for other content types
        testContainer = document.getElementById("test-container");
        if (userTests.length === 0) {
            testContainer.innerHTML = "No tests yet...";
        } else {
            testContainer.innerHTML = ""; // Clear container
            for(let i = 0; i<userTests.length; i++) {
                let div = document.createElement("div");
                div.className = "course-container";
                let p = document.createElement("p");
                p.innerHTML = `Test: ${userTests[i].name}`;
                div.appendChild(p);

                // Add delete button
                let deleteBtn = document.createElement("button");
                deleteBtn.className = "remove-btn";
                deleteBtn.textContent = "Delete Test";
                deleteBtn.onclick = function() { deleteItem(this); };
                div.appendChild(deleteBtn);

                div.dataset.index = i;
                div.dataset.type = "test";
                testContainer.appendChild(div);
            }
        }

        // Repeat similar pattern for templates, cover pages, and attachments
        templateContainer = document.getElementById("template-container");
        if (userTemplates.length === 0) {
            templateContainer.innerHTML = "No templates yet...";
        } else {
            templateContainer.innerHTML = "";
            for(let i = 0; i<userTemplates.length; i++) {
                let div = document.createElement("div");
                div.className = "course-container";
                let p = document.createElement("p");
                p.innerHTML = `Template: ${userTemplates[i].name}`;
                div.appendChild(p);

                let deleteBtn = document.createElement("button");
                deleteBtn.className = "remove-btn";
                deleteBtn.textContent = "Delete Template";
                deleteBtn.onclick = function() { deleteItem(this); };
                div.appendChild(deleteBtn);

                div.dataset.index = i;
                div.dataset.type = "template";
                templateContainer.appendChild(div);
            }
        }

        coverpageContainer = document.getElementById("coverpage-container");
        if (userCoverPages.length === 0) {
            coverpageContainer.innerHTML = "No cover pages yet...";
        } else {
            coverpageContainer.innerHTML = "";
            for(let i = 0; i<userCoverPages.length; i++) {
                let div = document.createElement("div");
                div.className = "course-container";
                let p = document.createElement("p");
                p.innerHTML = `Cover Page: ${userCoverPages[i].name}`;
                div.appendChild(p);

                let deleteBtn = document.createElement("button");
                deleteBtn.className = "remove-btn";
                deleteBtn.textContent = "Delete Cover Page";
                deleteBtn.onclick = function() { deleteItem(this); };
                div.appendChild(deleteBtn);

                div.dataset.index = i;
                div.dataset.type = "coverpage";
                coverpageContainer.appendChild(div);
            }
        }

        attachmentContainer = document.getElementById("attachment-container");
        if (userAttachments.length === 0) {
            attachmentContainer.innerHTML = "No attachments yet...";
        } else {
            attachmentContainer.innerHTML = "";
            for(let i = 0; i<userAttachments.length; i++) {
                let div = document.createElement("div");
                div.className = "course-container";
                let p = document.createElement("p");
                p.innerHTML = `Attachment: ${userAttachments[i].name}`;
                div.appendChild(p);

                let deleteBtn = document.createElement("button");
                deleteBtn.className = "remove-btn";
                deleteBtn.textContent = "Delete Attachment";
                deleteBtn.onclick = function() { deleteItem(this); };
                div.appendChild(deleteBtn);

                div.dataset.index = i;
                div.dataset.type = "attachment";
                attachmentContainer.appendChild(div);
            }
        }
    }

    function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) { // if you find the cookie that starts with csrftoken=
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
    }


async function updateUserData(){
    const newPW = document.getElementById("pwchange").value.trim();
    const PWchecked = document.getElementById("checkPW").checked;
    const newUN = document.getElementById("unchange").value.trim();
    const UNchecked = document.getElementById("checkUN").checked;
    let data = [];

    let pw = password;  // Default to the existing password
    let un = username;  // Default to the existing username

    if(PWchecked){
        if(newPW == ""){
            alert("Invalid password");
            return;
        }
        pw = newPW; // Set the new password if checked
    }

    if(UNchecked){
        if(newUN == ""){
            alert("Invalid username");
            return;
        }
        un = newUN; // Set the new username if checked
    }

    try{
        const response = await fetch('/api/update_user/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                "username": username,
                "new_username": un,
                "new_password": pw,
                "update_username": UNchecked
            })
        });
        const data = await response.json();
        if (response.ok) {
            alert(data.message || `User Data successfully changed.`);
            username = un;
            password = pw;
            document.getElementById("searchSelector").value = "UN";
            document.getElementById("searchField").value = un;
            filterSearch();
        } else {
            alert(data.message || 'An error occurred while changing user data.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while connecting to the server.');
    }
}

async function deleteItem(element) {
    const parentDiv = element.closest('div[data-type]');
    const type = parentDiv.dataset.type;
    const index = parseInt(parentDiv.dataset.index);

    // Use a separate variable for model_type to avoid breaking the switch
    const modelType = type.charAt(0).toUpperCase() + type.slice(1); // "test" -> "Test"

    let itemToDelete;
    switch(type) {
        case 'question':
            itemToDelete = { ...userQuestions[index] }; // clone
            break;
        case 'test':
            itemToDelete = { ...userTests[index] };
            break;
        case 'template':
            itemToDelete = { ...userTemplates[index] };
            break;
        case 'coverpage':
            itemToDelete = { ...userCoverPages[index] };
            break;
        case 'attachment':
            itemToDelete = { ...userAttachments[index] };
            break;
        default:
            console.error('Unknown item type:', type);
            return;
    }

    if (!confirm(`Are you sure you want to delete this ${modelType}?`)) return;

    try {
        const response = await fetch('/api/delete_item/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                model_type: modelType,
                id: itemToDelete.id,
                username: username,
                identity: itemToDelete.courseID
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Remove item from the local list
            switch(type) {
                case 'question': userQuestions.splice(index, 1); break;
                case 'test': userTests.splice(index, 1); break;
                case 'template': userTemplates.splice(index, 1); break;
                case 'coverpage': userCoverPages.splice(index, 1); break;
                case 'attachment': userAttachments.splice(index, 1); break;
            }

            parentDiv.remove();
            alert(data.message || `${modelType} successfully deleted.`);
            updateUserData();  // optional refresh
        } else {
            alert(data.message || 'An error occurred while deleting the item.');
        }

    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while connecting to the server.');
    }
}



    function sortList(list, type){
        //Lists are objects sorted by courseID. Each object value is an array containing a list for that course's elements
        // The exception to this is test/questions, in which each list is an object containing an object containing arrays listing the elements 
        let newList = []
        for(courseID in list){
            switch(type){
            case "test":
            case "question": 
                course = list[courseID];
                for(subList in course){
                    for(let i=0;i<course[subList].length;i++){
                        newList.push(course[subList][i]);
                        newList[newList.length-1].courseID = courseID
                    }
                }
            break;
            default: 
                for(let i = 0;i<list[courseID].length;i++){
                        newList.push(list[courseID][i]);
                        newList[newList.length-1].courseID = courseID
                }
            }    
        }
        return newList;
    }





// does NOT actually export CSV. exports a xlsx, Excel file
// function to export parts of database or entire database
// cannot do multiple export types
// valid export types are: 'course', 'test', 'question', 'all courses', 'everything'
// 'everything' is meant ONLY for WEBMASTER
// for now, THERE IS NO 'all courses' EXPORT TYPE (in javascript)
// relies on a list of ids being sent. only 1 list of ids should be sent
function ajaxExportCsv(exportType) {

    // /*
    // these are lists of IDs for each (1st column in database)
    let course = [];
    let test = [];
    let questions = [];
    // const typeOfExport = ["course"]; // used for testing just backend
    // */

    if (exportType === 'course') {
        const checkboxes = document.querySelectorAll('input[name="courseExportSelect"]:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        course = selectedIds;
    }
    else if (exportType === 'test') {
        const checkboxes = document.querySelectorAll('input[name="testExportSelect"]:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        test = selectedIds;
    }
    else if (exportType === 'question') {
        const checkboxes = document.querySelectorAll('input[name="questionExportSelect"]:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        questions = selectedIds;
    }
    else if (exportType === 'all courses') {
        //
    }
    else if (exportType === 'everything') {
        //
    }
    else {
        // wrong type handling goes here
    }

    const typeOfExport = [exportType]

    fetch("/export-csv/", {
        method: "POST",
        body: JSON.stringify({
            course, test, questions, typeOfExport
        }),
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"  // CSRF token for Django security
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not OK");
            }
            return response.blob();  // Convert response to binary blob
        })
        .then(blob => {
            // Create a temporary download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "database_export.xlsx";  // Name of the downloaded file
            document.body.appendChild(a);
            a.click();  // Trigger the download
            a.remove();  // Clean up the DOM
            window.URL.revokeObjectURL(url);  // Release memory
        })
        .catch(error => {
            console.error("Error downloading the file:", error);
        });


}

function openPreviewMenu() {
    document.getElementById("previewMenu").style.display = "flex";
}

function closePreviewMenu() {
    document.getElementById("previewMenu").style.display = "none";
    document.getElementById("selectionMenu").style.display = "none";
    document.getElementById("selectionMenu").innerHTML = "";
}

function loadActualPreview(whatToLoad) {
    document.getElementById("selectionMenu").style.display = "flex";

    fetch('/export_preview/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
        },
        body: whatToLoad
    })

        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("selectionMenu");
            container.innerHTML = ""; // Clear

            // If Courses
            if (whatToLoad === 'courses') {
                container.innerHTML += `<h3>Courses</h3>`;
                if (data.courses && data.courses.length > 0) {
                    data.courses.forEach(course => {
                        container.innerHTML += `<div><input type="checkbox" name="courseExportSelect" value="${course.id}"><strong>${course.name}</strong></input></div>`;
                    });
                    container.innerHTML += '<button class="add-btn cool-press" onclick="ajaxExportCsv(\'course\')">Export</button>';
                } else {
                    container.innerHTML += `<p>No courses found.</p>`;
                }
            }

            // If Tests
            else if (whatToLoad === 'tests') {
                container.innerHTML += `<h3>Tests</h3>`;
                if (data.tests && data.tests.length > 0) {
                    data.tests.forEach(test => {
                        container.innerHTML += `<div><input type="checkbox" name="testExportSelect" value="${test.id}"><strong>${test.name}</strong></input></div>`;
                    });
                    container.innerHTML += '<button class="add-btn cool-press" onclick="ajaxExportCsv(\'test\')">Export</button>';
                } else {
                    container.innerHTML += `<p>No tests found.</p>`;
                }
            }

            // If Questions
            else if (whatToLoad === 'questions') {
                container.innerHTML += `<h3>Questions</h3>`;
                if (data.questions && data.questions.length > 0) {
                    data.questions.forEach(q => {

                        let questionType = '';
                        if (q.qtype === 'mc') {
                            questionType = 'Multiple Choice: ';
                        }
                        else if (q.qtype === 'tf') {
                            questionType = 'True/False: ';
                        }
                        else if (q.qtype === 'fb') {
                            questionType = 'Fill In The Blank: ';
                        }
                        else if (q.qtype === 'es') {
                            questionType = 'Essay: ';
                        }
                        else if (q.qtype === 'ma') {
                            questionType = 'Matching: ';
                        }
                        else {
                            questionType = 'Multiple Selection: ';
                        }

                        container.innerHTML += `<div><input type="checkbox" name="questionExportSelect" value="${q.id}"> <strong>${questionType}</strong> ${q.text}</input></div>`;

                        /*
                        // options and answers SHOULD go here
                        data.options.forEach(o => {
                            if (o.question_id === q.id) {
                                container.innerHTML += `<div>${o.text}</div>`;
                            }
                        });

                        data.answers.forEach(a => {
                            if (a.question_id === q.id) {
                                container.innerHTML += `<div>${a.text}</div>`;
                            }
                        });
                        // end of q & a here
                         */

                    });
                    container.innerHTML += '<button class="add-btn cool-press" onclick="ajaxExportCsv(\'question\')">Export</button>';
                } else {
                    container.innerHTML += `<p>No questions found.</p>`;
                }
            }
            else {
                console.log("Wrong parameter value given to loadActualPreview function");
            }

        })
        .catch(err => {
            console.error("Error fetching [] preview:", err);
            document.getElementById("selectionMenu").innerHTML = "<p>Failed to load [] data.</p>";
        });
}


function importTableToDatabase() {
    let importButton = document.getElementById("importedCsv");
    let imported_csv_file;

    if (importButton.files.length > 0) {
        imported_csv_file = importButton.files[0];
    }
    else {
        alert("Please select a CSV file to import.");
        return;
    }

    let table_to_import;
    let radioButton = document.querySelector('input[name="importSelection"]:checked');

    if (radioButton)
    {
        table_to_import = radioButton.value;
    }
    else
    {
        alert("Please select a table to import.");
        return;
    }

    let deleteAllRows = "true"; // hardcoded for testing

    let formData = new FormData();
    formData.append("imported_csv_file", imported_csv_file);
    formData.append("table_to_import", table_to_import);
    formData.append("deleteAllRows", deleteAllRows);

    fetch("/import_csv/", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })

        .then(response => response.json())
        .then(data => {
            if (data.success)
            {
                if (data.rows_skipped && data.rows_skipped.length > 0)
                {
                    alert("Partial success. Skipped rows were: " + data.rows_skipped);
                }
                else
                {
                    alert("Import successful!");
                }
            }
            else
            {
                alert("Import failed. Error: " + data.error);
            }
        })
        .catch(err => {
            console.error("Unexpected JS error while importing CSV: ", err);
        });
}

function openImportMenu() {
    document.getElementById("importMenu").style.display = "flex";
}

function closeImportMenu() {
    document.getElementById("importMenu").style.display = "none";

    // clears radio button selection
    let radioButtonList = document.querySelectorAll('input[name="importSelection"]');
    radioButtonList.forEach(radioButton => radioButton.checked = false);

    // clears file input
    let fileInput = document.getElementById('importedCsv');
    fileInput.value = '';

}

function downloadCsvTemplate()
{
    let modelForTemplate;
    let radioButton = document.querySelector('input[name="importSelection"]:checked');

    if (radioButton)
    {
        modelForTemplate = radioButton.value;
    }
    else
    {
        alert("Please select a model to download template for");
        return;
    }

    fetch('/create_csv_template/', {
        method: 'POST',
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: modelForTemplate
    })
        .then(response => {
            if (!response.ok)
            {
                return response.json().then(data => {
                    alert("Error: " + data.error);
                    return null; // return null to signal we should not continue
                });
            }
            return response.blob();
        })
        .then(blob => {
            if (!blob)
            {
                return;
            }
            // create a temporary download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "templateForImport.csv";  // name of downloaded file
            document.body.appendChild(a);
            a.click();  // trigger download
            a.remove();  // clean up the DOM
            window.URL.revokeObjectURL(url);  // release memory
        })
        .catch(error => console.error("An error occurred while attempting to download template", error));
}


</script>

<div id="previewMenu" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:80%; max-height:80%; overflow-y:auto;">
        <h2>Export Preview Menu</h2>
        <button class="add-btn cool-press" onclick="closePreviewMenu()" style="float:right;">Close</button>
        <div>
            <button class="add-btn cool-press" onclick="loadActualPreview('courses')">Courses</button>
            <button class="add-btn cool-press" onclick="loadActualPreview('tests')">Tests</button>
            <button class="add-btn cool-press" onclick="loadActualPreview('questions')">Questions</button>
            <button class="add-btn cool-press" onclick="ajaxExportCsv('all courses')">All Courses</button>
            <button class="add-btn cool-press" onclick="ajaxExportCsv('everything')">Entire Database</button>
        </div>
        <!-- since this div container style's display will be set to "flex", flex-direction: column makes it so
                         the items will be populated/grow vertically. by default, flex-container items grow horizontally -->
        <div id="selectionMenu" style="display:none; flex-direction: column; gap: 10px;">
            <!-- placeholder -->
        </div>
    </div>
</div>

<!-- since this div container style's display will be set to "flex", "flex-direction: column" makes it so
    the items will be populated/grow vertically. by default, flex-container items grow horizontally -->
    <div id="importMenu" style="display:none; flex-direction: column; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
        <div class="textbook-container" style="background:white; padding:30px; border-radius:10px; width:80%; max-width:1000px; max-height:80%; overflow-y:auto; box-shadow:0 8px 16px rgba(0,0,0,0.3);">
            <h2>Import Menu <button class="add-btn cool-press" onclick="closeImportMenu()" style="float:right;">Close</button></h2>
        <h3>Please select a table to import.</h3>
        <p>Please use commas as delimiters. If a field has a space, comma, line break, or carriage return, enclose the field in double quotes (").
            If an enclosed field has double quotes inside the field, replace each single double quotes (") with
            2 double quotes ("").
            To assign a null or None value, use "NULL" (case-sensitive).
            If a field value is required but the value is invalid or not given, the row will be skipped.
            If a column is given that doesn't exist in the model, nothing will be imported.
            IDs do not need to be given. If IDs are given, any rows with duplicate IDs will be skipped. If relational IDs are given
            but the object with the given relational ID does not exist, the row will be skipped.
            All prior records will be deleted. Only supports UTF-8 encoding. Templates can be downloaded to see examples.</p>
        <h4>Example</h4>
        <p>id,text,course_id<br>
            1,"sample text",5</p>

        <div>
            <form>
                <label><input type="radio" name="importSelection" value="Textbook">Textbook</label><br>
                <label><input type="radio" name="importSelection" value="UserProfile">UserProfile</label><br>
                <label><input type="radio" name="importSelection" value="Course">Course</label><br>
                <label><input type="radio" name="importSelection" value="Question">Question</label><br>
                <label><input type="radio" name="importSelection" value="Options">Options</label><br>
                <label><input type="radio" name="importSelection" value="Answers">Answers</label><br>
                <!-- <label><input type="radio" name="importSelection" value="DynamicQuestionParameter">DynamicQuestionParameter</label><br> -->
                <label><input type="radio" name="importSelection" value="Template">Template</label><br>
                <label><input type="radio" name="importSelection" value="CoverPage">CoverPage</label><br>
                <label><input type="radio" name="importSelection" value="Attachment">Attachment</label><br>
                <label><input type="radio" name="importSelection" value="Test">Test</label><br>
                <label><input type="radio" name="importSelection" value="TestPart">TestPart</label><br>
                <label><input type="radio" name="importSelection" value="TestSection">TestSection</label><br>
                <label><input type="radio" name="importSelection" value="TestQuestion">TestQuestion</label><br>
                <label><input type="radio" name="importSelection" value="Feedback">Feedback</label><br>
                <label><input type="radio" name="importSelection" value="FeedbackResponse">FeedbackResponse</label><br><br>
            </form>
            <button class="add-btn cool-press" onclick="importTableToDatabase()">Import</button>
            <input type="file" id="importedCsv" accept=".csv" />
            <button class="add-btn cool-press" onclick="downloadCsvTemplate()">Download Template</button>
        </div>

    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.waves.min.js"></script>

<script>
    const vantaEffect = VANTA.WAVES({
      el: "#vanta-bg",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      minHeight: 200.00,
      minWidth: 200.00,
      scale: 1.00,
      scaleMobile: 1.00,
      color: 0xc365f,
      backgroundColor: 0x2e3a42,
      waveSpeed: 0.10
    });
    </script>
    
    <script>
        // Watch for <details> being opened or closed
        document.querySelectorAll("details").forEach(details => {
          details.addEventListener("toggle", () => {
            if (vantaEffect && vantaEffect.resize) {
              vantaEffect.resize(); // Smoothly adjust background size
            }
          });
        });
        </script>
        
    



</body>
</html>
